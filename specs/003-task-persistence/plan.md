# Implementation Plan: Task Persistence

**Branch**: `003-task-persistence` | **Date**: 2025-12-31 | **Spec**: [spec.md](./spec.md)

## Summary

Add file-based persistence to the Todo CLI application to fix the bug where tasks disappear between CLI invocations. Tasks and the ID counter will be persisted to `~/.todo/tasks.json` using atomic JSON file writes.

## Technical Context

**Language/Version**: Python 3.13+ (existing)
**Primary Dependencies**: Standard library `json`, `pathlib` (no new dependencies)
**Storage**: JSON file at `~/.todo/tasks.json`
**Testing**: pytest (existing)
**Target Platform**: Windows/macOS/Linux CLI
**Project Type**: Single CLI project
**Performance Goals**: Sub-millisecond read/write for typical todo lists (<100 tasks)
**Constraints**: Atomic writes to prevent corruption, handle missing/corrupted files gracefully
**Scale/Scope**: Single user, hundreds of tasks max

## Constitution Check

### ⚠️ CONSTITUTION VIOLATION DETECTED

| Constitution Section | Requirement | Violation |
|---------------------|-------------|-----------|
| Section 2: Out of Scope | "File or database persistence" | **FR-001, FR-002, FR-004, FR-006** require file persistence |

### Justification for Violation

The current in-memory-only design makes the application fundamentally unusable. Users cannot:
- Add tasks that persist between sessions
- Build a meaningful todo list over time
- Trust any task data will remain available

**This is a bug fix, not a feature enhancement.** The original specification was incomplete - an in-memory-only todo list is not functional.

### Proposed Amendment

Section 2 "Out of Scope" should add a clarifying exception:

```
### Out of Scope (Original)
- File or database persistence

### Amendment for Bug Fix
- File or database persistence (EXCEPT: user home directory JSON file for task persistence)
```

## Project Structure

### Documentation (this feature)

```text
specs/003-task-persistence/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # N/A - no unknowns requiring research
├── data-model.md        # N/A - existing Task model sufficient
└── tasks.md             # Generated by /sp.tasks
```

### Source Code (repository root)

```text
src/
├── models/
│   └── task.py          # Add from_dict() classmethod
├── storage/
│   └── task_store.py    # Add _load() and _save() methods
└── cli/
    └── commands.py      # No changes needed

tests/
├── unit/
│   ├── test_task.py     # Add tests for from_dict()
│   └── test_task_store.py  # Add persistence tests
└── integration/         # (optional) CLI-level tests
```

**Structure Decision**: Minimal changes to existing structure. Only `task.py` and `task_store.py` need modifications.

## Implementation Approach

### Phase 1: Task Model Enhancement

1. Add `from_dict()` classmethod to `Task` class for deserialization

### Phase 2: TaskStore Persistence

1. Add `storage_file` path parameter to `__init__`
2. Add `_load()` method to read JSON from disk
3. Add `_save()` method to write JSON atomically (temp file + rename)
4. Call `_load()` on initialization
5. Call `_save()` after any mutation (add, update, delete)

### Phase 3: Testing

1. Unit tests for `Task.from_dict()`
2. Integration tests for persistence across CLI invocations
3. Edge case tests (corrupted file, missing directory)

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| JSON format | Human-readable, easy debugging, no new dependencies |
| `~/.todo/tasks.json` | Standard location for app config, cross-platform |
| Atomic rename | Prevents corruption if write is interrupted |
| Load on init, save on mutation | Simple, reliable, minimal code changes |

## Artifacts Generated

- `plan.md` (this file)
- Ready for `/sp.tasks` to generate implementation tasks
